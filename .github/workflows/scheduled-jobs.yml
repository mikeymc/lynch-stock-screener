# ABOUTME: GitHub Actions workflow to trigger scheduled background jobs
# ABOUTME: Runs nightly screening and caching jobs via the job API

name: Scheduled Jobs

on:
  schedule:
    # Full screening at 10:00 PM ET (3:00 AM UTC) daily
    - cron: '0 3 * * *'
    # News cache at 10:10 PM ET (3:10 AM UTC) daily
    - cron: '10 3 * * *'
    # 10K cache at 10:20 PM ET (3:20 AM UTC) daily
    - cron: '20 3 * * *'
    # 8K cache at 10:30 PM ET (3:30 AM UTC) daily
    - cron: '30 3 * * *'
    # Outlook cache at 11:00 PM ET (4:00 AM UTC) daily - after screening
    - cron: '0 4 * * *'
    # Price history cache at 12:00 AM ET (5:00 AM UTC) daily
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: true
        default: 'full_screening'
        type: choice
        options:
          - full_screening
          - price_history_cache
          - news_cache
          - 10k_cache
          - 8k_cache
          - outlook_cache

jobs:
  trigger-job:
    runs-on: ubuntu-latest
    steps:
      - name: Determine job type
        id: job-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.job_type }}" >> $GITHUB_OUTPUT
          else
            # Determine job type based on cron schedule (hour at 3, 4, or 5 AM UTC)
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            
            if [ "$HOUR" = "03" ] && [ "$MINUTE" -lt "5" ]; then
              echo "type=full_screening" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "03" ] && [ "$MINUTE" -ge "5" ] && [ "$MINUTE" -lt "15" ]; then
              echo "type=news_cache" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "03" ] && [ "$MINUTE" -ge "15" ] && [ "$MINUTE" -lt "25" ]; then
              echo "type=10k_cache" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "03" ] && [ "$MINUTE" -ge "25" ]; then
              echo "type=8k_cache" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "04" ]; then
              echo "type=outlook_cache" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "05" ]; then
              echo "type=price_history_cache" >> $GITHUB_OUTPUT
            else
              echo "type=full_screening" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Trigger background job
        run: |
          JOB_TYPE="${{ steps.job-type.outputs.type }}"
          echo "Triggering job: $JOB_TYPE"

          # Set params based on job type (all default to US region)
          if [ "$JOB_TYPE" = "outlook_cache" ]; then
            PARAMS='{"region": "us"}'
          else
            PARAMS='{}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_URL }}/api/jobs" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -d "{\"type\": \"$JOB_TYPE\", \"params\": $PARAMS}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to trigger job"
            exit 1
          fi

          JOB_ID=$(echo "$BODY" | jq -r '.job_id')
          echo "Job ID: $JOB_ID"
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Monitor job (optional)
        if: success()
        run: |
          echo "Job triggered successfully. Monitor at:"
          echo "${{ secrets.API_URL }}/api/jobs/${{ steps.job-type.outputs.job_id }}"
