# ABOUTME: GitHub Actions workflow to trigger scheduled background jobs
# ABOUTME: Runs nightly screening and caching jobs via the job API

name: Scheduled Jobs

on:
  schedule:
    # Alerts check - every hour on the hour
    - cron: '0 * * * *'
    # Price Update - every 5 minutes (fast TradingView fetch)
    - cron: '*/5 * * * *'
    # Full screening at 8:00 PM ET (1:00 AM UTC) daily - staggered 3h before other heavy jobs
    - cron: '0 1 * * *'
    # News cache every 2 hours from 6am-8pm ET on weekdays
    - cron: '0 11 * * 1-5'  # 6am ET
    - cron: '0 13 * * 1-5'  # 8am ET
    - cron: '0 15 * * 1-5'  # 10am ET
    - cron: '0 17 * * 1-5'  # 12pm ET
    - cron: '0 19 * * 1-5'  # 2pm ET
    - cron: '0 21 * * 1-5'  # 4pm ET
    - cron: '0 23 * * 1-5'  # 6pm ET
    - cron: '0 1 * * 2-6'   # 8pm ET (1am UTC next day = Tue-Sat in UTC)
    # 8-K cache every 2 hours from 6am-8pm ET on weekdays (with RSS filtering)
    - cron: '10 11 * * 1-5'  # 6:10am ET
    - cron: '10 13 * * 1-5'  # 8:10am ET
    - cron: '10 15 * * 1-5'  # 10:10am ET
    - cron: '10 17 * * 1-5'  # 12:10pm ET
    - cron: '10 19 * * 1-5'  # 2:10pm ET
    - cron: '10 21 * * 1-5'  # 4:10pm ET
    - cron: '10 23 * * 1-5'  # 6:10pm ET
    - cron: '10 1 * * 2-6'   # 8:10pm ET (1:10am UTC next day = Tue-Sat in UTC)
    # 10K cache - every 2 hours (:20) to interleave with 8-K
    - cron: '20 11 * * 1-5'  # 6:20am ET
    - cron: '20 13 * * 1-5'  # 8:20am ET
    - cron: '20 15 * * 1-5'  # 10:20am ET
    - cron: '20 17 * * 1-5'  # 12:20pm ET
    - cron: '20 19 * * 1-5'  # 2:20pm ET
    - cron: '20 21 * * 1-5'  # 4:20pm ET
    - cron: '20 23 * * 1-5'  # 6:20pm ET
    - cron: '20 1 * * 2-6'   # 8:20pm ET
    # Form 4 cache - every 2 hours (:30) to interleave with 8-K
    - cron: '30 11 * * 1-5'  # 6:30am ET
    - cron: '30 13 * * 1-5'  # 8:30am ET
    - cron: '30 15 * * 1-5'  # 10:30am ET
    - cron: '30 17 * * 1-5'  # 12:30pm ET
    - cron: '30 19 * * 1-5'  # 2:30pm ET
    - cron: '30 21 * * 1-5'  # 4:30pm ET
    - cron: '30 23 * * 1-5'  # 6:30pm ET
    - cron: '30 1 * * 2-6'   # 8:30pm ET
    # Price history cache at 11:00 PM ET (4:00 AM UTC) daily - after full_screening completes
    - cron: '0 4 * * *'
    # Outlook cache at 12:00 AM ET (5:00 AM UTC) daily - after price_history completes
    - cron: '0 5 * * *'
    # Transcript cache at 12:30 AM ET (5:30 AM UTC) daily - runs last
    # Run 4x daily to catch new publications promptly
    - cron: '30 5 * * *'  # 12:30 AM ET
    - cron: '30 11 * * *' # 6:30 AM ET
    - cron: '30 17 * * *' # 12:30 PM ET 
    - cron: '30 23 * * *' # 6:30 PM ET

    # Forward metrics cache at 2:00 AM ET (7:00 AM UTC) daily - after outlook completes
    - cron: '0 7 * * *'
    # Strategy execution at 9:30 AM ET (2:30 PM UTC) on weekdays - just after market open
    - cron: '30 14 * * 1-5'
    # Benchmark snapshot at 4:05 PM ET (9:05 PM UTC) on weekdays - Market Close
    - cron: '5 21 * * 1-5'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: true
        default: 'full_screening'
        type: choice
        options:
          - check_alerts
          - full_screening
          - price_history_cache
          - news_cache
          - 10k_cache
          - 8k_cache
          - form4_cache
          - outlook_cache
          - transcript_cache
          - forward_metrics_cache
          - price_update
          - strategy_execution
          - benchmark_snapshot
          - historical_fundamentals_cache
          - quarterly_fundamentals_cache

jobs:
  trigger-job:
    runs-on: ubuntu-latest
    steps:
      - name: Determine job type
        id: job-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.job_type }}" >> $GITHUB_OUTPUT
          else
            # Match on the ACTUAL cron expression that triggered this run
            # This is reliable even if the job is delayed by hours
            SCHEDULE="${{ github.event.schedule }}"

            case "$SCHEDULE" in
              "*/5 * * * *") echo "type=price_update" >> $GITHUB_OUTPUT ;;
              "0 * * * *")   echo "type=check_alerts" >> $GITHUB_OUTPUT ;;
              "0 1 * * *")   echo "type=full_screening" >> $GITHUB_OUTPUT ;;
              "0 11 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 13 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 15 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 17 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 19 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 21 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 23 * * 1-5") echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "0 1 * * 2-6")  echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "10 11 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 13 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 15 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 17 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 19 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 21 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 23 * * 1-5") echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "10 1 * * 2-6")  echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "20 11 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 13 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 15 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 17 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 19 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 21 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 23 * * 1-5") echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "20 1 * * 2-6")  echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "30 11 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 13 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 15 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 17 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 19 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 21 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 23 * * 1-5") echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "30 1 * * 2-6")  echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "0 4 * * *")   echo "type=price_history_cache" >> $GITHUB_OUTPUT ;;
              "0 5 * * *")   echo "type=outlook_cache" >> $GITHUB_OUTPUT ;;
              "30 5 * * *")  echo "type=transcript_cache" >> $GITHUB_OUTPUT ;;
              "30 11 * * *") echo "type=transcript_cache" >> $GITHUB_OUTPUT ;;
              "30 17 * * *") echo "type=transcript_cache" >> $GITHUB_OUTPUT ;;
              "30 23 * * *") echo "type=transcript_cache" >> $GITHUB_OUTPUT ;;
              "0 7 * * *")   echo "type=forward_metrics_cache" >> $GITHUB_OUTPUT ;;
              "30 14 * * 1-5") echo "type=strategy_execution" >> $GITHUB_OUTPUT ;;
              "5 21 * * 1-5") echo "type=benchmark_snapshot" >> $GITHUB_OUTPUT ;;
              *)             echo "Unknown schedule: $SCHEDULE" && exit 1 ;;
            esac
          fi

      - name: Trigger background job
        run: |
          JOB_TYPE="${{ steps.job-type.outputs.type }}"
          echo "Triggering job: $JOB_TYPE"

          # Set params based on job type (all default to US region)
          if [ "$JOB_TYPE" = "outlook_cache" ]; then
            PARAMS='{"region": "us"}'
          elif [ "$JOB_TYPE" = "form4_cache" ]; then
            PARAMS='{"region": "us", "use_rss": true}'
          elif [ "$JOB_TYPE" = "8k_cache" ]; then
            PARAMS='{"use_rss": true}'
          elif [ "$JOB_TYPE" = "10k_cache" ]; then
            PARAMS='{"use_rss": true}'
          elif [ "$JOB_TYPE" = "price_update" ]; then
             # Default to US for speed, can be expanded if needed
             PARAMS='{"regions": ["us"]}'
          elif [ "$JOB_TYPE" = "full_screening" ]; then
            PARAMS='{}'
          elif [ "$JOB_TYPE" = "strategy_execution" ]; then
            # Run all enabled strategies
            PARAMS='{}'
          else
            PARAMS='{}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_URL }}/api/jobs" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -d "{\"type\": \"$JOB_TYPE\", \"params\": $PARAMS}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to trigger job"
            exit 1
          fi

          JOB_ID=$(echo "$BODY" | jq -r '.job_id')
          echo "Job ID: $JOB_ID"
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Monitor job (optional)
        if: success()
        run: |
          echo "Job triggered successfully. Monitor at:"
          echo "${{ secrets.API_URL }}/api/jobs/${{ steps.job-type.outputs.job_id }}"
