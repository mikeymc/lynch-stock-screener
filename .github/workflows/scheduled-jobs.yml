# ABOUTME: GitHub Actions workflow to trigger scheduled background jobs
# ABOUTME: Runs nightly screening and caching jobs via the job API

name: Scheduled Jobs

on:
  schedule:
    # Full screening at 10:00 PM ET (3:00 AM UTC) daily
    - cron: '0 3 * * *'
    # News cache at 10:10 PM ET (3:10 AM UTC) daily
    - cron: '10 3 * * *'
    # 10K cache at 10:20 PM ET (3:20 AM UTC) daily
    - cron: '20 3 * * *'
    # 8K cache at 10:30 PM ET (3:30 AM UTC) daily
    - cron: '30 3 * * *'
    # Form 4 cache at 10:40 PM ET (3:40 AM UTC) daily
    - cron: '40 3 * * *'
    # Price history cache at 11:00 PM ET (4:00 AM UTC) daily
    - cron: '0 4 * * *'
    # Outlook cache at 12:00 AM ET (5:00 AM UTC) daily
    - cron: '0 5 * * *'
    # Transcript cache at 12:30 AM ET (5:30 AM UTC) daily - runs last
    - cron: '30 5 * * *'
    # Forward metrics cache at 1:00 AM ET (6:00 AM UTC) daily
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: true
        default: 'full_screening'
        type: choice
        options:
          - full_screening
          - price_history_cache
          - news_cache
          - 10k_cache
          - 8k_cache
          - form4_cache
          - outlook_cache
          - transcript_cache
          - forward_metrics_cache

jobs:
  trigger-job:
    runs-on: ubuntu-latest
    steps:
      - name: Determine job type
        id: job-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.job_type }}" >> $GITHUB_OUTPUT
          else
            # Match on the ACTUAL cron expression that triggered this run
            # This is reliable even if the job is delayed by hours
            SCHEDULE="${{ github.event.schedule }}"
            
            case "$SCHEDULE" in
              "0 3 * * *")   echo "type=full_screening" >> $GITHUB_OUTPUT ;;
              "10 3 * * *")  echo "type=news_cache" >> $GITHUB_OUTPUT ;;
              "20 3 * * *")  echo "type=10k_cache" >> $GITHUB_OUTPUT ;;
              "30 3 * * *")  echo "type=8k_cache" >> $GITHUB_OUTPUT ;;
              "40 3 * * *")  echo "type=form4_cache" >> $GITHUB_OUTPUT ;;
              "0 4 * * *")   echo "type=price_history_cache" >> $GITHUB_OUTPUT ;;
              "0 5 * * *")   echo "type=outlook_cache" >> $GITHUB_OUTPUT ;;
              "30 5 * * *")  echo "type=transcript_cache" >> $GITHUB_OUTPUT ;;
              "0 6 * * *")   echo "type=forward_metrics_cache" >> $GITHUB_OUTPUT ;;
              *)             echo "Unknown schedule: $SCHEDULE" && exit 1 ;;
            esac
          fi

      - name: Trigger background job
        run: |
          JOB_TYPE="${{ steps.job-type.outputs.type }}"
          echo "Triggering job: $JOB_TYPE"

          # Set params based on job type (all default to US region)
          if [ "$JOB_TYPE" = "outlook_cache" ] || [ "$JOB_TYPE" = "form4_cache" ]; then
            PARAMS='{"region": "us"}'
          elif [ "$JOB_TYPE" = "full_screening" ]; then
            PARAMS='{"force_refresh": true}'
          else
            PARAMS='{}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_URL }}/api/jobs" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -d "{\"type\": \"$JOB_TYPE\", \"params\": $PARAMS}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to trigger job"
            exit 1
          fi

          JOB_ID=$(echo "$BODY" | jq -r '.job_id')
          echo "Job ID: $JOB_ID"
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Monitor job (optional)
        if: success()
        run: |
          echo "Job triggered successfully. Monitor at:"
          echo "${{ secrets.API_URL }}/api/jobs/${{ steps.job-type.outputs.job_id }}"
